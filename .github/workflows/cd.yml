name: CD - Build and Push Docker Image

on:
  push:
    branches: [main,feature/*]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GH_TOKEN }}
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ghcr.io/roh963/nest-postgress-project:latest,ghcr.io/roh963/nest-postgress-project:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
          ACCESS_TOKEN_TTL_MIN: ${{ secrets.ACCESS_TOKEN_TTL_MIN }}
          REFRESH_TOKEN_TTL_DAYS: ${{ secrets.REFRESH_TOKEN_TTL_DAYS }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_CALLBACK_URL: ${{ secrets.GOOGLE_CALLBACK_URL }}
          OAUTH_GITHUB_CLIENT_ID: ${{ secrets.OAUTH_GITHUB_CLIENT_ID }}
          OAUTH_GITHUB_CLIENT_SECRET: ${{ secrets.OAUTH_GITHUB_CLIENT_SECRET }}
          OAUTH_GITHUB_CALLBACK_URL: ${{ secrets.OAUTH_GITHUB_CALLBACK_URL }}
          OAUTH_CALLBACK_BASE: ${{ secrets.OAUTH_CALLBACK_BASE }}
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
          WEBHOOK_URL_SLACK: ${{ secrets.WEBHOOK_URL_SLACK }}
          THROTTLE_TTL: ${{ secrets.THROTTLE_TTL }}
          THROTTLE_LIMIT: ${{ secrets.THROTTLE_LIMIT }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/Nest-Postgress-Project || git clone https://github.com/roh963/nest-postgress-project.git ~/Nest-Postgress-Project && cd ~/Nest-Postgress-Project
            git fetch origin
            git reset --hard origin/${{ github.ref_name }}
            SHA=${{ github.sha }}
            sed -i "s|ghcr.io/roh963/nest-postgress-project:.*|ghcr.io/roh963/nest-postgress-project:${SHA}|g" docker-compose.prod.yml
            
            # Auto-create .env.prod with secrets (mapping OAUTH_GITHUB_* to GITHUB_* for app)
            cat > .env.prod << EOF
            DB_PASSWORD=$DB_PASSWORD
            DATABASE_URL=postgresql://postgres:$DB_PASSWORD@db:5432/nestdb?schema=public
            JWT_SECRET=$JWT_SECRET
            JWT_REFRESH_SECRET=$JWT_REFRESH_SECRET
            ACCESS_TOKEN_TTL_MIN=$ACCESS_TOKEN_TTL_MIN
            REFRESH_TOKEN_TTL_DAYS=$REFRESH_TOKEN_TTL_DAYS
            GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
            GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET
            GOOGLE_CALLBACK_URL=$GOOGLE_CALLBACK_URL
            GITHUB_CLIENT_ID=$OAUTH_GITHUB_CLIENT_ID
            GITHUB_CLIENT_SECRET=$OAUTH_GITHUB_CLIENT_SECRET
            GITHUB_CALLBACK_URL=$OAUTH_GITHUB_CALLBACK_URL
            OAUTH_CALLBACK_BASE=$OAUTH_CALLBACK_BASE
            CLOUDINARY_CLOUD_NAME=$CLOUDINARY_CLOUD_NAME
            CLOUDINARY_API_KEY=$CLOUDINARY_API_KEY
            CLOUDINARY_API_SECRET=$CLOUDINARY_API_SECRET
            WEBHOOK_URL_SLACK=$WEBHOOK_URL_SLACK
            REDIS_URL=redis://redis:6379
            THROTTLE_TTL=$THROTTLE_TTL
            THROTTLE_LIMIT=$THROTTLE_LIMIT
            PORT=3000
            NODE_ENV=production
            CORS_ORIGINS=http://13.60.181.126,https://example.com
            EOF
            
            # Secure permissions
            chmod 600 .env.prod
            
            docker compose -f docker-compose.prod.yml down || true
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d
            sleep 60
            docker compose -f docker-compose.prod.yml logs --tail=100 api | tail -20

  smoke-tests:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Smoke Tests
        env:
          STAGING_URL: http://13.60.181.126:3000
        run: |
          npm install -g newman newman-reporter-html
          newman run postman/collection.json \
            --environment postman/environment.json \
            --env-var baseUrl=$STAGING_URL \
            --reporters cli,html \
            --reporter-html-export smoke-report.html \
            --bail
      - name: Upload Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-report
          path: smoke-report.html